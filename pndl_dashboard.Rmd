---
title: "German Commuter Statistics"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    css: "css/fonts.css"
runtime: shiny_prerendered
---

```{html import-stylesheets, include = FALSE}
<link href='https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap' rel='stylesheet' type='text/css'>
<link href='https://cdn.jsdelivr.net/gh/tonsky/FiraCode@5/distr/fira_code.css' rel='stylesheet' type='text/css'>
```

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(reactable)
library(htmltools)
library(highcharter)
library(colorspace)
```

```{r data, include=FALSE}
laender_df <- data.table::fread("laender_df.csv", encoding = "UTF-8")
```

Sidebar {.sidebar}
=======================================================================

Access to official data provided by the [datenguide API](https://github.com/datenguide/datenguide-api) -- using the [datenguidepy](https://github.com/CorrelAid/datenguide-python) package

---

```{r}
selectInput("year", label = "Year:",
            choices = 2011:2019, selected = 2019)

selectInput("plot_var", label = "Statistic to plot:",
            choices = c("In", "Out", "Balance"), selected = "Balance")

selectInput("get_pct", label = "As a percentage of the population?",
            choices = c("Yes", "No"), selected = "No")
```

```{r prep-df-fn, context="server"}
transform_stat <- function(data, to_pct = input$get_pct) {
  if (to_pct == "Yes") {
    data %>% 
      mutate(across(c(In, Out, Balance), ~ round(.x * 100 / pop, 2)))
  } else {
    data
  }
}
```

NUTS-1 (Bundesl√§nder)
=======================================================================

Column {data-width=700, .tabset}
-----------------------------------------------------------------------

### Table

```{r barchart-tbl-fn, context="server"}
bar_chart <- function(label, width = "100%", height = "14px", fill = "#cccccc",
                      align = "left") {
  label <- div(style = list(marginLeft = "5px", marginRight = "5px"), label)
  bar <- div(style = list(background = fill, width = width, height = height,
                          float = align))
  if (align == "right") {
    div(style = list(display = "flex", alignItems = "center",
                     justifyContent = "flex-end"), label, bar)
  } else {
    div(style = list(display = "flex", alignItems = "center"), bar, label)
  }
}
```

```{r laender-tbl-rndr}
reactableOutput("laender_tbl")
```

```{r laender-tbl-srvr, context="server"}
output$laender_tbl <- renderReactable({
  laender_df %>% 
    transform_stat() %>% 
    filter(year == input$year) %>% 
    select(Bundesland = name, Out, Balance, In) %>% 
    reactable(
      pagination = FALSE, borderless = TRUE,
      defaultSorted = "Balance", defaultSortOrder = "desc",
      columns = list(
        Bundesland = colDef(defaultSortOrder = "asc"),
        Balance = colDef(
          name = emo::ji("balance_scale"),
          width = 80,
          cell = function(value) format(value, big.mark = " "),
          style = list(background = "#f8f8f8"),
          align = "center"
        ),
        Out = colDef(
          cell = function(value) {
            width <- paste0(value * .7 * 100 / max(.$Out), "%")
            value <- format(value, big.mark = " ")
            bar_chart(value, width = width, fill = "#c7522b", align = "right")
          }
        ),
        In = colDef(
          cell = function(value) {
            width <- paste0(value * .7 * 100 / max(.$Out), "%")
            value <- format(value, big.mark = " ")
            bar_chart(value, width = width, fill = "#008585", align = "left")
          },
          align = "left"
        )
      )
    )
})
```

### Choropleth map

```{r mapcols-fn, context="server"}
hc_map_colors <- function(hc_map, var) {
  if (var == "Balance") {
      ret <- hc_map %>% 
        hc_colorAxis(stops = color_stops(
          colors = divergingx_hcl(12, rev = TRUE)[3:12]
        ))
  }
  if (var == "In") {
      ret <- hc_map %>% 
        hc_colorAxis(stops = color_stops(
          colors = divergingx_hcl(20, rev = TRUE)[11:20]
        ))
  }
  if (var == "Out") {
      ret <- hc_map %>% 
        hc_colorAxis(stops = color_stops(
          colors = divergingx_hcl(20)[11:20]
        ))
  }
  ret
}
```

```{r laender-map-rndr}
highchartOutput("laender_map")
```

```{r laender-map-srvr, context="server"}
output$laender_map <- renderHighchart({
  hcmap(
    "countries/de/de-all.js",
    data = laender_df %>% 
      transform_stat() %>% 
      filter(year == input$year),
    value = input$plot_var,
    joinBy = c("woe-name", "name"),
    name = input$plot_var,
    dataLabels = list(enabled = TRUE, format = "{point.name}"),
    borderColor = "#fafafa",
    borderWidth = 0.1
  ) %>% 
    hc_map_colors(var = input$plot_var) %>% 
    hc_add_theme(hc_theme(chart = list(style = list(
      fontFamily = "var(--text-font-family), var(--text-font-base)",
      fontVariantNumeric = "tabular-nums"
    ))))
})
```

### Time series

```{r laender-ts-rndr}
highchartOutput("laender_ts")
```

```{r laender-ts-srvr, context="server"}
output$laender_ts <- renderHighchart({
  laender_df %>% 
    transform_stat() %>% 
    hchart("line", hcaes(x = year, y = !!sym(input$plot_var), group = name),
           marker = list(enabled = FALSE)) %>% 
    hc_xAxis(title = "") %>% 
    hc_tooltip(crosshairs = TRUE, headerFormat = "")
})
```

Column {data-width=300}
-----------------------------------------------------------------------

### Description

Lorem ipsum

NUTS-3 (Kreise)
=======================================================================

Column {data-width=700, .tabset}
-----------------------------------------------------------------------

### Table

`<TODO>`

### Choropleth map

`<TODO>`

Column {data-width=300}
-----------------------------------------------------------------------

### Description

Lorem ipsum
