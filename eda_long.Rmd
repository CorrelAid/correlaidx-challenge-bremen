---
title: "Exploring Datenguide"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: paper
    highlight: kate
    toc: true
    toc_depth: 2
    toc_float: true
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  dev.args = list(bg = "transparent", type = "cairo-png"),
  fig.retina = 2,
  fig.path = "figs/"
)
```

```{r load-r, message=FALSE}
library(tidyverse)
library(reticulate)
library(reactable)

source("scripts/plot_styling.R", echo = FALSE)
```

```{python load-py}
from datenguidepy.query_builder import Query
from datenguidepy.query_helper import get_regions, get_statistics, get_availability_summary
```

# Names and descriptions of all statistics

```{python get-stat-descriptions}
stat_des_all = get_statistics().reset_index()
```

```{r stat_tbl}
py$stat_des_all %>% 
  reactable(filterable = TRUE, highlight = TRUE, wrap = FALSE,
            onClick = "expand", rowStyle = list(cursor = "pointer"),
            details = function(index) .$long_description[index],
            columns = list(statistic = colDef(width = 80),
                           long_description = colDef(maxWidth = 200)))
```

# Decide on region ID

```{python get-hb-codes}
get_regions().query("name.str.contains('Bremen', na = False)")
```

```{python view-availability}
hb_ids = ["04", "040", "04011", "04011000"]

for region_id in hb_ids:
  print(
    get_availability_summary()
    .query("region_id == @region_id")
    .dropna()
    .shape
  )
```

# Statistics on commuters

```{python relevant-stats-en}
# datenguidepy also provides English translations for statistics
commuter_stat_des = (get_statistics(target_language = "en")
                       .query("statistic.str.contains('^PEN')")
                       .reset_index()
                       .sort_values(by = "statistic", ignore_index = True))
```

```{r commuter-des-en-tbl}
py$commuter_stat_des %>% 
  reactable(highlight = TRUE, sortable = FALSE, wrap = FALSE,
            onClick = "expand", rowStyle = list(cursor = "pointer"),
            details = function(index) .$long_description[index],
            columns = list(statistic = colDef(width = 80),
                           long_description = colDef(maxWidth = 200)))
```

# Query Länder data

```{python query-laender-data}
nuts1_regions = (get_regions()
                   .query("level == 'nuts1'")
                   .index
                   .to_list())

laender_df = (Query
                .region(nuts1_regions, ["PEN071", "PEN072", "PEN079"])
                .results()
                .drop_duplicates(ignore_index = True)
                .rename(columns = {"PEN071": "einpendl",
                                   "PEN072": "auspendl",
                                   "PEN079": "saldo"})
                .filter(["name", "year", "einpendl", "auspendl", "saldo"]))
```

```{r laender-tbl}
py$laender_df %>% 
  reactable(defaultPageSize = 16,
            columns = list(name = colDef(filterable = TRUE),
                           year = colDef(filterable = TRUE)))
```

# Exploratory plots

```{r ts-plot, fig.asp=1, out.width="100%"}
py$laender_df %>% 
  mutate(auspendl = -auspendl) %>% 
  pivot_longer(einpendl:saldo, names_to = "statistic") %>% 
  ggplot(aes(lubridate::make_date(year), value, colour = statistic)) +
  geom_hline(yintercept = 0, colour = "#cccccc", size = 1) +
  geom_line() +
  geom_point() +
  scale_x_date(guide = guide_axis(check.overlap = TRUE)) +
  facet_wrap(~name) +
  labs(x = NULL, y = NULL,
       title = "Number of commuters across Bundesländer borders") +
  theme(legend.title = element_blank()) +
  panel_grid("XxYy")
```

